@page "/card-search"
@rendermode InteractiveServer
@using PokemonCardCollector.Models
@using PokemonCardCollector.Services
@inject ICardCollectionService CardCollectionService
@inject NavigationManager NavigationManager
@inject ILogger<CardSearch> Logger

<PageTitle>Search Cards - Pokemon Card Collector</PageTitle>

<PageHeader 
    Title="Search Cards"
    Description="Browse the Pokémon card database and add cards to your collection." />

<div class="search-section mb-4">
    <SearchBar 
        Placeholder="Search by card name..."
        OnSearchRequested="SearchByName"
        IsSearching="@isSearching" />
    
    <div class="row mt-3">
        <div class="col-md-12">
            <div class="form-group">
                <label for="advancedSearch" class="form-label">Advanced Search (Name + Card Number)</label>
                <div class="input-group">
                    <input 
                        type="text"
                        class="form-control"
                        placeholder="Pokemon name (required)"
                        @bind="advancedSearchName" />
                    <input 
                        type="text"
                        id="advancedSearch"
                        class="form-control"
                        placeholder="Card number (e.g., 5)"
                        @bind="advancedSearchNumber"
                        @onkeyup="HandleAdvancedSearchKeyPress" />
                    <button 
                        class="btn btn-primary"
                        type="button"
                        @onclick="SearchByNameAndNumber"
                        disabled="@(isSearching || string.IsNullOrWhiteSpace(advancedSearchName))">
                        @if (isSearching)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        }
                        <span>Search</span>
                    </button>
                </div>
                <small class="text-muted">Combine Pokemon name with card number for specific results</small>
            </div>
        </div>
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(errorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <span class="bi bi-exclamation-circle me-2"></span>
        @errorMessage
        <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
    </div>
}

@if (!string.IsNullOrWhiteSpace(successMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <span class="bi bi-check-circle me-2"></span>
        @successMessage
        <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
    </div>
}

<div class="search-results">
    @if (isSearching)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted">Searching for cards...</p>
        </div>
    }
    else if (searchResults != null && searchResults.Count > 0)
    {
        <div class="results-header mb-3">
            <h4>Found @searchResults.Count card@(searchResults.Count != 1 ? "s" : "")</h4>
        </div>
        
        @foreach (var card in searchResults)
        {
            <CardCard 
                Card="@card"
                ShowAddButton="true"
                IsAdding="@(addingCardId == card.ApiId)"
                OnAdd="AddCardToCollection" />
        }
    }
    else if (hasSearched && (searchResults == null || searchResults.Count == 0))
    {
        <div class="alert alert-info text-center py-5">
            <span class="bi bi-info-circle me-2"></span>
            <p class="mb-0">No cards found. Try searching with a different name or number.</p>
        </div>
    }
    else if (!hasSearched)
    {
        <div class="alert alert-secondary text-center py-5">
            <span class="bi bi-search me-2"></span>
            <p class="mb-0">Enter a search term to find cards.</p>
        </div>
    }
</div>

@code {
    private List<Card> searchResults = new();
    private bool isSearching = false;
    private bool hasSearched = false;
    private string? errorMessage;
    private string? successMessage;
    private string advancedSearchName = string.Empty;
    private string advancedSearchNumber = string.Empty;
    private string addingCardId = string.Empty;

    private async Task SearchByName(string searchTerm)
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            errorMessage = "Please enter a card name to search.";
            return;
        }

        try
        {
            isSearching = true;
            hasSearched = true;
            errorMessage = null;
            successMessage = null;
            
            searchResults = (await CardCollectionService.BrowseCardsByNameAsync(searchTerm))
                .ToList();
            
            if (searchResults.Count == 0)
            {
                Logger.LogInformation("Card search returned no results for: {SearchTerm}", searchTerm);
            }
            else
            {
                Logger.LogInformation("Card search found {CardCount} results for: {SearchTerm}", 
                    searchResults.Count, searchTerm);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "=== ERROR in SearchByName ===");
            errorMessage = "An error occurred while searching. Please try again.";
            searchResults = new();
        }
        finally
        {
            isSearching = false;
        }
    }

    private async Task SearchByNameAndNumber()
    {
        if (string.IsNullOrWhiteSpace(advancedSearchName))
        {
            errorMessage = "Please enter a Pokemon name to search.";
            return;
        }

        try
        {
            isSearching = true;
            hasSearched = true;
            errorMessage = null;
            successMessage = null;
            
            // If card number is provided, combine it with the name
            if (!string.IsNullOrWhiteSpace(advancedSearchNumber))
            {
                searchResults = (await CardCollectionService.BrowseCardsByNumberAsync(
                    advancedSearchNumber, 
                    null))
                    .Where(c => c.Name.Contains(advancedSearchName, StringComparison.OrdinalIgnoreCase))
                    .ToList();
                
                Logger.LogInformation("Advanced search found {CardCount} results for: {Name} #{Number}", 
                    searchResults.Count, advancedSearchName, advancedSearchNumber);
            }
            else
            {
                // If no card number, just search by name
                searchResults = (await CardCollectionService.BrowseCardsByNameAsync(advancedSearchName))
                    .ToList();
                
                Logger.LogInformation("Card search found {CardCount} results for: {SearchTerm}", 
                    searchResults.Count, advancedSearchName);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error in advanced search");
            errorMessage = "An error occurred while searching. Please try again.";
            searchResults = new();
        }
        finally
        {
            isSearching = false;
        }
    }

    private async Task AddCardToCollection(string apiId)
    {
        try
        {
            addingCardId = apiId;
            errorMessage = null;
            successMessage = null;
            
            var addedCard = await CardCollectionService.AddCardFromApiAsync(apiId);
            
            successMessage = $"✓ {addedCard.Name} added to your collection!";
            Logger.LogInformation("Card added to collection: {CardName} ({ApiId})", 
                addedCard.Name, apiId);
            
            // Remove from search results to prevent re-adding
            searchResults.RemoveAll(c => c.ApiId == apiId);
        }
        catch (InvalidOperationException ex)
        {
            errorMessage = ex.Message;
            Logger.LogWarning(ex, "Error adding card to collection");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Unexpected error adding card to collection");
            errorMessage = "An error occurred while adding the card. Please try again.";
        }
        finally
        {
            addingCardId = string.Empty;
        }
    }

    private async Task HandleCardNumberKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(advancedSearchName))
        {
            await SearchByNameAndNumber();
        }
    }

    private async Task HandleAdvancedSearchKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(advancedSearchName))
        {
            await SearchByNameAndNumber();
        }
    }
}
